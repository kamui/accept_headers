<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Accept headers by kamui</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Accept headers</h1>
        <p class="header">A ruby library that does content negotiation and parses and sorts http accept headers</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/kamui/accept_headers/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/kamui/accept_headers/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/kamui/accept_headers">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/kamui">kamui</a></p>


      </header>
      <section>
        <p><a href="https://travis-ci.org/kamui/accept_headers"><img src="https://travis-ci.org/kamui/accept_headers.png" alt="Build Status"></a>
<a href="https://codeclimate.com/github/kamui/accept_headers"><img src="https://codeclimate.com/github/kamui/accept_headers/badges/gpa.svg" alt="Code Climate"></a>
<a href="https://codeclimate.com/github/kamui/accept_headers"><img src="https://codeclimate.com/github/kamui/accept_headers/badges/coverage.svg" alt="Test Coverage"></a></p>

<h1>
<a id="acceptheaders" class="anchor" href="#acceptheaders" aria-hidden="true"><span class="octicon octicon-link"></span></a>AcceptHeaders</h1>

<p><strong>AcceptHeaders</strong> is a ruby library that does content negotiation and parses and sorts http accept headers.</p>

<p>Some features of the library are:</p>

<ul>
<li>Strict adherence to <a href="http://www.w3.org/Protocols/rfc2616/rfc2616.html">RFC 2616</a>, specifically <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">section 14</a>
</li>
<li>Full support for the <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a>, <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.3">Accept-Encoding</a>,
and <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.4">Accept-Language</a> HTTP request headers</li>
<li>
<code>Accept-Charset</code> is not supported because it's <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Content_negotiation#The_Accept-Charset.3A_header">obsolete</a>
</li>
<li>Parser tested against all IANA registered <a href="https://www.iana.org/assignments/media-types/media-types.xhtml">media types</a> and <a href="https://www.iana.org/assignments/http-parameters/http-parameters.xml#content-coding">encodings</a>
</li>
<li>A comprehensive <a href="http://github.com/kamui/accept_headers/tree/master/spec/">spec suite</a> that covers many edge cases</li>
</ul>

<p>This library is optimistic when parsing headers. If a specific media type, encoding, or language can't be parsed, is in an invalid format, or contains invalid characters, it will skip that specific entry when constructing the sorted list. If a <code>q</code> value can't be read or is in the wrong format (more than 3 decimal places), it will default it to <code>0.001</code> so it still has a chance to match. Lack of an explicit <code>q</code> value of course defaults to 1.</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Add this line to your application's Gemfile:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-k">gem</span> <span class="pl-s1"><span class="pl-pds">'</span>accept_headers<span class="pl-pds">'</span></span></pre></div>

<p>And then execute:</p>

<pre><code>$ bundle
</code></pre>

<p>Or install it yourself as:</p>

<pre><code>$ gem install accept_headers
</code></pre>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h2>

<h3>
<a id="accept" class="anchor" href="#accept" aria-hidden="true"><span class="octicon octicon-link"></span></a>Accept</h3>

<p><code>AcceptHeaders::MediaType::Negotiator</code> is a class that is initialized with an <code>Accept</code> header string and will internally store an array of <code>MediaType</code>s in descending order according to the spec, which takes into account <code>q</code> value, <code>type</code>/<code>subtype</code> and <code>extensions</code> specificity.</p>

<div class="highlight highlight-ruby"><pre>accept_header <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">'</span>Accept: text/*;q=0.3, text/html;q=0.7, text/html;level=1, text/html;level=2;q=0.4, */*;q=0.5<span class="pl-pds">'</span></span>
media_types <span class="pl-k">=</span> <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">MediaType</span>::<span class="pl-s3">Negotiator</span>.<span class="pl-k">new</span>(accept_header)

media_types.list

<span class="pl-c"># Returns:</span>

[
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">MediaType</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>html<span class="pl-pds">'</span></span>, <span class="pl-c1">extensions:</span> { <span class="pl-s1"><span class="pl-pds">'</span>level<span class="pl-pds">'</span></span> =&gt; <span class="pl-s1"><span class="pl-pds">'</span>1<span class="pl-pds">'</span></span> }),
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">MediaType</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>html<span class="pl-pds">'</span></span>, <span class="pl-c1">q:</span> <span class="pl-c1">0.7</span>),
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">MediaType</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span>, <span class="pl-c1">q:</span> <span class="pl-c1">0.5</span>),
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">MediaType</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>html<span class="pl-pds">'</span></span>, <span class="pl-c1">q:</span> <span class="pl-c1">0.4</span>, <span class="pl-c1">extensions:</span> { <span class="pl-s1"><span class="pl-pds">'</span>level<span class="pl-pds">'</span></span> =&gt; <span class="pl-s1"><span class="pl-pds">'</span>2<span class="pl-pds">'</span></span> }),
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">MediaType</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span>, <span class="pl-c1">q:</span> <span class="pl-c1">0.3</span>)
]</pre></div>

<p><code>#negotiate</code> takes an array of media range strings supported (by your API or route/controller) and returns the best supported <code>MediaType</code> and the <code>extensions</code> params from the matching internal media type.</p>

<p>This will first check the available list for any matching media types with a <code>q</code> of 0 and skip any matches. It does this because the RFC specifies that if the <code>q</code> value is 0, then content with this parameter is <code>not acceptable</code>. Then it'll look to the highest <code>q</code> values and look for matches in descending <code>q</code> value order and return the first match (accounting for wildcards). Finally, if there are no matches, it returns <code>nil</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c"># The same media_types variable as above</span>
media_types.negotiate([<span class="pl-s1"><span class="pl-pds">'</span>text/html<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>text/plain<span class="pl-pds">'</span></span>])

<span class="pl-c"># Returns this equivalent:</span>

<span class="pl-s3">AcceptHeader</span>::<span class="pl-s3">MediaType</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>text<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>html<span class="pl-pds">'</span></span>, <span class="pl-c1">extensions:</span> { <span class="pl-s1"><span class="pl-pds">'</span>level<span class="pl-pds">'</span></span> =&gt; <span class="pl-s1"><span class="pl-pds">'</span>1<span class="pl-pds">'</span></span> })</pre></div>

<p>It returns the matching <code>MediaType</code>, so you can see which one matched and also access the <code>extensions</code> params. For example, if you wanted to put your API version in the extensions, you could then retrieve the value.</p>

<div class="highlight highlight-ruby"><pre>versions_header <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">'</span>Accept: application/json;version=2,application/json;version=1;q=0.8<span class="pl-pds">'</span></span>
media_types <span class="pl-k">=</span> <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">MediaType</span>::<span class="pl-s3">Negotiator</span>.<span class="pl-k">new</span>(versions_header)

m <span class="pl-k">=</span> media_types.negotiate(<span class="pl-s1"><span class="pl-pds">'</span>application/json<span class="pl-pds">'</span></span>)
puts m.extensions[<span class="pl-s1"><span class="pl-pds">'</span>version<span class="pl-pds">'</span></span>] <span class="pl-c"># returns '2'</span></pre></div>

<p><code>#accept?</code>:</p>

<div class="highlight highlight-ruby"><pre>media_types.accept?(<span class="pl-s1"><span class="pl-pds">'</span>text/html<span class="pl-pds">'</span></span>) <span class="pl-c"># true</span></pre></div>

<h3>
<a id="accept-encoding" class="anchor" href="#accept-encoding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Accept-Encoding</h3>

<p><code>AcceptHeader::Encoding::Encoding</code>:</p>

<div class="highlight highlight-ruby"><pre>accept_encoding <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">'</span>Accept-Encoding: deflate; q=0.5, gzip, compress; q=0.8, identity<span class="pl-pds">'</span></span>
encodings <span class="pl-k">=</span> <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">Encoding</span>::<span class="pl-s3">Negotiator</span>.<span class="pl-k">new</span>(accept_encoding)

encodings.list

<span class="pl-c"># Returns:</span>

[
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">Encoding</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>gzip<span class="pl-pds">'</span></span>),
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">Encoding</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>compress<span class="pl-pds">'</span></span>, <span class="pl-c1">q:</span> <span class="pl-c1">0.8</span>),
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">Encoding</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>deflate<span class="pl-pds">'</span></span>, <span class="pl-c1">q:</span> <span class="pl-c1">0.5</span>)
]</pre></div>

<p><code>#negotiate</code>:</p>

<div class="highlight highlight-ruby"><pre>encodings.negotiate([<span class="pl-s1"><span class="pl-pds">'</span>gzip<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>compress<span class="pl-pds">'</span></span>])

<span class="pl-c"># Returns this equivalent:</span>

<span class="pl-s3">AcceptHeader</span>::<span class="pl-s3">Encoding</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>gzip<span class="pl-pds">'</span></span>)</pre></div>

<p><code>#accept?</code>:</p>

<div class="highlight highlight-ruby"><pre>encodings.accept?(<span class="pl-s1"><span class="pl-pds">'</span>gzip<span class="pl-pds">'</span></span>) <span class="pl-c"># true</span>

<span class="pl-c"># Identity is accepted as long as it's not explicitly rejected 'identity;q=0'</span>

encodings.accept?(<span class="pl-s1"><span class="pl-pds">'</span>identity<span class="pl-pds">'</span></span>) <span class="pl-c"># true</span></pre></div>

<h3>
<a id="accept-language" class="anchor" href="#accept-language" aria-hidden="true"><span class="octicon octicon-link"></span></a>Accept-Language</h3>

<p><code>Accept::Language::Negotiator</code>:</p>

<div class="highlight highlight-ruby"><pre>accept_language <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">'</span>Accept-Language: en-*, en-us, *;q=0.8<span class="pl-pds">'</span></span>
languages <span class="pl-k">=</span> <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">Language</span>::<span class="pl-s3">Negotiator</span>.<span class="pl-k">new</span>(accept_language)

languages.list

<span class="pl-c"># Returns:</span>

[
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">Language</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>en<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>us<span class="pl-pds">'</span></span>),
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">Language</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>en<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span>),
  <span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">Language</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span>, <span class="pl-c1">q:</span> <span class="pl-c1">0.8</span>)
]</pre></div>

<p><code>#negotiate</code>:</p>

<div class="highlight highlight-ruby"><pre>languages.negotiate([<span class="pl-s1"><span class="pl-pds">'</span>en-us<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>zh-Hant<span class="pl-pds">'</span></span>])

<span class="pl-c"># Returns this equivalent:</span>

<span class="pl-s3">AcceptHeaders</span>::<span class="pl-s3">Language</span>.<span class="pl-k">new</span>(<span class="pl-s1"><span class="pl-pds">'</span>en<span class="pl-pds">'</span></span>, <span class="pl-s1"><span class="pl-pds">'</span>us<span class="pl-pds">'</span></span>)</pre></div>

<p><code>#accept?</code>:</p>

<div class="highlight highlight-ruby"><pre>languages.accept?(<span class="pl-s1"><span class="pl-pds">'</span>en-gb<span class="pl-pds">'</span></span>) <span class="pl-c"># true</span></pre></div>

<h2>
<a id="rack-middleware" class="anchor" href="#rack-middleware" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rack Middleware</h2>

<p>Add the middleware:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-k">require</span> <span class="pl-s1"><span class="pl-pds">'</span>accept_headers/middleware<span class="pl-pds">'</span></span>
use <span class="pl-s3">AcceptHeaders</span>::<span class="pl-vo">Middleware</span>
run <span class="pl-vo">YourApp</span></pre></div>

<p>Simple way to set the content response headers based on the request accept headers and the supported media types, encodings, and languages provided by the app or route.</p>

<div class="highlight highlight-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">YourApp</span>
  <span class="pl-k">def</span> <span class="pl-en">initialize</span>(<span class="pl-vpf">app</span>)
    <span class="pl-vo">@app</span> <span class="pl-k">=</span> app
  <span class="pl-k">end</span>

  <span class="pl-k">def</span> <span class="pl-en">call</span>(<span class="pl-vpf">env</span>)
    <span class="pl-c"># List your arrays of supported media types, encodings, languages. This can be global or per route/controller</span>
    supported_media_types <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">%w[</span>application/json application/xml text/html text/plain<span class="pl-pds">]</span></span>
    supported_encodings <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">%w[</span>gzip identify<span class="pl-pds">]</span></span>
    supported_languages <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">%w[</span>en-US en-GB<span class="pl-pds">]</span></span>

    <span class="pl-c"># Call the Negotiators and pass in the supported arrays and it'll return the best match</span>
    matched_media_type <span class="pl-k">=</span> env[<span class="pl-s1"><span class="pl-pds">"</span>accept_headers.media_types<span class="pl-pds">"</span></span>].negotiate(supported_media_types)
    matched_encoding <span class="pl-k">=</span> env[<span class="pl-s1"><span class="pl-pds">"</span>accept_headers.encodings<span class="pl-pds">"</span></span>].negotiate(supported_encodings)
    matched_language <span class="pl-k">=</span> env[<span class="pl-s1"><span class="pl-pds">"</span>accept_headers.languages<span class="pl-pds">"</span></span>].negotiate(supported_languages)

    <span class="pl-c"># Set a default, in this case an empty string, in case of a bad header that cannot be parsed</span>
    <span class="pl-c"># The return value is a MediaType, Encoding, or Language depending on the case:</span>
    <span class="pl-c"># On MediaType, you can call #type ('text'), #subtype ('html'), #media_range ('text/html') to get the stringified parts</span>
    <span class="pl-c"># On Encoding, you can call #encoding to get the string encoding ('gzip')</span>
    <span class="pl-c"># On Language, you can call #primary_tag ('en'), #subtag ('us'), or #language_tag ('en-us')</span>
    headers <span class="pl-k">=</span> {
      <span class="pl-s1"><span class="pl-pds">'</span>Content-Type<span class="pl-pds">'</span></span> =&gt; matched_media_type <span class="pl-k">?</span> matched_media_type.media_range : <span class="pl-s1"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>,
      <span class="pl-s1"><span class="pl-pds">'</span>Content-Encoding<span class="pl-pds">'</span></span> =&gt; matched_encoding <span class="pl-k">?</span> matched_encoding.encoding : <span class="pl-s1"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>,
      <span class="pl-s1"><span class="pl-pds">'</span>Content-Language<span class="pl-pds">'</span></span> =&gt; matched_language <span class="pl-k">?</span> matched_language.language_tag : <span class="pl-s1"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>,
    }

    [<span class="pl-c1">200</span>, headers, [<span class="pl-s1"><span class="pl-pds">"</span>Hello World!<span class="pl-pds">"</span></span>]]
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<h2>
<a id="contributing" class="anchor" href="#contributing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contributing</h2>

<ol>
<li>Fork it ( <a href="https://github.com/%5Bmy-github-username%5D/accept_headers/fork">https://github.com/[my-github-username]/accept_headers/fork</a> )</li>
<li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li>
<li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li>
<li>Push to the branch (<code>git push origin my-new-feature</code>)</li>
<li>Create a new Pull Request</li>
</ol>
      </section>
      <footer>
        <p><small>Hosted on <a href="http://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-18119942-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
